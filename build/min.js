(function(e,t){var n=function(){var e,t=[],n=function(n,r){if(t){r=r||[],e=e||[n,r];for(var i=0,s=t.length;i<s;i++)t[i].apply(e[0],e[1]);t=[]}};this.add=function(){for(var r=0,i=arguments.length;r<i;r++)t.push(arguments[r]);return e&&n(),this},this.execute=function(){return n(this,arguments),this}},r=function(e){var t="progress",i=[["resolve","done",new n,"resolved"],["reject","fail",new n,"rejected"],["notify","progress",new n]],s={},o={state:function(){return t},then:function(){var e=arguments;return r(function(t){i.forEach(function(n,r){var i=e[r];s[n[1]](typeof i=="function"?function(){var e=i.apply(this,arguments);e&&typeof e.promise=="function"&&e.promise().done(t.resolve).fail(t.reject).progress(t.notify)}:t[n[0]])})}).promise()},promise:function(e){return e?(Object.keys(o).forEach(function(t){e[t]=o[t]}),e):o}};return i.forEach(function(e,n){var r=e[2],i=e[3];o[e[1]]=r.add,i&&r.add(function(){t=i}),s[e[0]]=r.execute}),o.promise(s),e&&e.call(s,s),s};typeof define=="function"&&define.amd?define("dbjs/defer",[],function(){return r}):e.Deferred=r})(window),function(e,t){var n=e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.oIndexedDB||e.msIndexedDB,r=e.IDBKeyRange||e.webkitIDBKeyRange,i={readonly:"readonly",readwrite:"readwrite"},s=Object.prototype.hasOwnProperty;if(!n)throw"IndexedDB required";var o=e.Deferred;!o&&typeof require=="function"&&(o=require("deferred"));var u=function(e,t){var r=this,u=!1;this.add=function(t){if(u)throw"Database has been closed";var n=[];for(var s=0;s<arguments.length-1;s++)n[s]=arguments[s+1];var a=e.transaction(t,i.readwrite),f=a.objectStore(t),l=o();return n.forEach(function(e){var t;if(e.item&&e.key){var n=e.key;e=e.item,t=f.add(e,n)}else t=f.add(e);t.onsuccess=function(t){var n=t.target,r=n.source.keyPath;r===null&&(r="__id__"),Object.defineProperty(e,r,{value:n.result,enumerable:!0}),l.notify()}}),a.oncomplete=function(){l.resolve(n,r)},a.onerror=function(e){l.reject(n,e)},a.onabort=function(e){l.reject(n,e)},l.promise()},this.update=function(t){if(u)throw"Database has been closed";var n=[];for(var s=0;s<arguments.length-1;s++)n[s]=arguments[s+1];var a=e.transaction(t,i.readwrite),f=a.objectStore(t),l=f.keyPath,c=o();return n.forEach(function(e){var t;if(e.item&&e.key){var n=e.key;e=e.item,t=f.put(e,n)}else t=f.put(e);t.onsuccess=function(e){c.notify()}}),a.oncomplete=function(){c.resolve(n,r)},a.onerror=function(e){c.reject(n,e)},a.onabort=function(e){c.reject(n,e)},c.promise()},this.remove=function(t,n){if(u)throw"Database has been closed";var r=e.transaction(t,i.readwrite),s=r.objectStore(t),a=o(),f=s.delete(n);return r.oncomplete=function(){a.resolve(n)},r.onerror=function(e){a.reject(e)},a.promise()},this.close=function(){if(u)throw"Database has been closed";e.close(),u=!0,c[t]=null},this.get=function(t,n){if(u)throw"Database has been closed";var r=e.transaction(t),i=r.objectStore(t),s=o(),a=i.get(n);return a.onsuccess=function(e){s.resolve(e.target.result)},r.onerror=function(e){s.reject(e)},s.promise()},this.query=function(t,n){if(u)throw"Database has been closed";return new a(t,e,n)},this.drop=function(){var t=o(),r=e.name,i;return u||this.close(),i=n.deleteDatabase(r),i.onsuccess=function(e){t.resolve(r)},i.onerror=function(e){t.reject(e)},i.onblocked=function(e){t.reject(e)},t.promise()};for(var f=0,l=e.objectStoreNames.length;f<l;f++)(function(e){r[e]={};for(var t in r){if(!s.call(r,t)||t==="close")continue;r[e][t]=function(t){return function(){var n=[e].concat([].slice.call(arguments,0));return r[t].apply(r,n)}}(t)}})(e.objectStoreNames[f])},a=function(e,t,n){var i=this,s=function(i,s,u,a){var f=t.transaction(e),l=f.objectStore(e),c=n?l.index(n):l,h=i?r[i].apply(null,s):null,p=[],d=o(),v=[h];return u!=="count"&&v.push(a||"next"),c[u].apply(c,v).onsuccess=function(e){var t=e.target.result;typeof t==typeof 0?p=t:t&&(p.push("value"in t?t.value:t.key),t.continue())},f.oncomplete=function(){d.resolve(p)},f.onerror=function(e){d.reject(e)},f.onabort=function(e){d.reject(e)},d.promise()},u=function(e,t){var n="next",r="openCursor",i=[],u=!1,a=function(){var a=o();return s(e,t,r,u?n+"unique":n).then(function(e){e.constructor===Array&&i.forEach(function(t){if(!t||!t.length)return;t.length===2?e=e.filter(function(e){return e[t[0]]===t[1]}):e=e.filter(t[0])}),a.resolve(e)},a.reject,a.notify),a.promise()},f=function(){return n=null,r="count",{execute:a}},l=function(){return r="openKeyCursor",{desc:h,execute:a,filter:c,distinct:p}},c=function(){return i.push(Array.prototype.slice.call(arguments,0,2)),{keys:l,execute:a,filter:c,desc:h,distinct:p}},h=function(){return n="prev",{keys:l,execute:a,filter:c,distinct:p}},p=function(){return u=!0,{keys:l,count:f,execute:a,filter:c,desc:h}};return{execute:a,count:f,keys:l,filter:c,desc:h,distinct:p}};"only bound upperBound lowerBound".split(" ").forEach(function(e){i[e]=function(){return new u(e,arguments)}}),this.filter=function(){var e=new u(null,null);return e.filter.apply(e,arguments)},this.all=function(){return this.filter()}},f=function(e,t,n){typeof t=="function"&&(t=t());for(var r in t){var i=t[r];if(!s.call(t,r))continue;var o=n.createObjectStore(r,i.key);for(var u in i.indexes){var a=i.indexes[u];o.createIndex(u,a.key||u,Object.keys(a).length?a:{unique:!1})}}},l=function(e,t,n,r){var i=e.target.result,s=new u(i,t),a,f=o();return f.resolve(s),c[t]=i,f.promise()},c={},h={version:"0.8.0",open:function(e){var t,r=o();return c[e.server]?l({target:{result:c[e.server]}},e.server,e.version,e.schema).done(r.resolve).fail(r.reject).progress(r.notify):(t=n.open(e.server,e.version),t.onsuccess=function(t){l(t,e.server,e.version,e.schema).done(r.resolve).fail(r.reject).progress(r.notify)},t.onupgradeneeded=function(t){f(t,e.schema,t.target.result)},t.onerror=function(e){r.reject(e)}),r.promise()}};typeof define=="function"&&define.amd?define("dbjs/db",[],function(){return h}):e.db=h}(window);var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};(function(e,t){return typeof define=="function"&&define.amd?define("webdb",["dbjs/defer","dbjs/db"],t):e.kvDB=t(e.Deferred,e.db)})(window,function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v;return u="indexeddb",a="websql",o=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)},i=function(){return""+o()+o()+"-"+o()+"-"+o()+"-"+o()+"-"+o()+o()+o()},c=function(e){var t,n,r,i,s,o;n=e,o=p.call(arguments,1),r=function(e){var t,r;for(t in e)r=e[t],e.hasOwnProperty(t)&&(n[t]=r)};for(i=0,s=o.length;i<s;i++)t=o[i],r(t);return n},p=Array.prototype.slice,l={id:i(),version:"1",description:null,schema:null,websql:{size:5242880},type:function(){var e;e=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB;if(!e){e=window.openDatabase;if(!e)throw"Need IndexedDB or WebSQL supported in your browser.";return a}return u}()},n=function(){function e(e){this.config=e}return e}(),s=function(n){function r(){return d=r.__super__.constructor.apply(this,arguments),d}return __extends(r,n),r.prototype.open=function(){var n,r,i,s,o=this;n=this.config,n.server=n.id,i=n.schema,s=Object.keys(i)[0],r=e(),t.open(n).done(function(e){o.config._db=e[s],r.resolve()}).fail(function(){r.reject()})},r.prototype.close=function(){var e;return e=this.config,e._db.close()},r.prototype.create=function(e){var t;return t=this.config,t._db.add(e)},r.prototype.get=function(e){var t;return t=this.config,t._db.get(e)},r.prototype.all=function(){var e;return e=this.config,e._db.query().all().execute()},r.prototype.remove=function(e){var t;return t=this.config,t._db.remove(e)},r.prototype.clear=function(){var e;return e=this.config,e._db.clear()},r.prototype.drop=function(){var e;return e=this.config,e._db.drop()},r}(n),f=function(t){function n(){return v=n.__super__.constructor.apply(this,arguments),v}return __extends(n,t),n.prototype._generateFieldsStatement=function(e,t){var n,r,i,s,o,u,a,f,l;i=[],s=function(e,t,n,r){var i;return r==null&&(r=!1),i=[e],i.push(t),r&&i.push("PRIMARY KEY"),n.notNull&&i.push("NOT NULL"),!n["default"]||(i.push("DEFAULT"),i.push(n["default"])),n.autoIncrement&&i.push("AUTOINCREMENT"),i.join(" ")},o=e[t.keyPath],u={autoIncrement:t.autoIncrement,notNull:!0},i.push(s(t.keyPath,o.type,u,!0)),l=Object.keys(e);for(a=0,f=l.length;a<f;a++)n=l[a],r=e[n],i.push(s(n,r.type,r,!1));return i.join(", ")},n.prototype._qmarks=function(e){var t,n;n=e,t=[];while(n>0)t.push("?"),n--;return t.join(",")},n.prototype.open=function(){var t,n,r,i,s,o,u,a,f,l,c,h;c=this,t=this.config,a=t.schema,r=t.id,i=t.description||r,l=Object.keys(a)[0],o=a[l].fields,u=a[l].key,h=t.version,f=t.size,s=e();if(!o)throw"No fields defined in config object";return n=openDatabase(r,h,i,f),n.transaction(function(e){return e.executeSql("CREATE TABLE IF NOT EXISTS "+l+" ("+c._generateFieldsStatement(o,u)+");",null,function(){c.config._db=n,s.resolve()},function(){return console.log("SQL statement error ",arguments[1])})}),s},n.prototype.close=function(){},n.prototype.create=function(t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;c=this,n=this.config,f=n.schema,l=Object.keys(f)[0],a=t,r=e();if(!a)return r.reject(),r;s=Object.keys(a),u=[];for(o=p=0,m=s.length;0<=m?p<m:p>m;o=0<=m?++p:--p)u.push("?");h=[];for(d=0,v=s.length;d<v;d++)i=s[d],h.push(a[i]);return n._db.transaction(function(e){var t,n;return n=function(){return r.resolve(a)},t=function(){var e;return e=arguments[1],e.code===e.CONSTRAINT_ERR?c.get(a.id).done(function(e){r.resolve(e)}).fail(function(){r.reject()}):r.reject()},e.executeSql("INSERT INTO "+l+" ("+s.join(",")+") VALUES ("+u+");",h,n,t)}),r},n.prototype.get=function(t){var n,r,i,s,o;return n=this.config,s=n.schema,o=Object.keys(s)[0],i=s[o].key.keyPath,r=e(),t?(n._db.transaction(function(e){var n,s;return s=function(){var e,t;t=arguments[1],e=t.rows.item(0),r.resolve(e)},n=function(){return console.log(arguments[1]),r.reject()},e.executeSql("SELECT * FROM "+o+" WHERE "+i+"=?;",[t],s,n)}),r):(r.reject(),r)},n.prototype.all=function(){var t,n,r,i,s;return s=this,t=this.config,r=t.schema,i=Object.keys(r)[0],n=e(),t._db.transaction(function(e){var t,r;return r=function(){var e,t,r,i,s;i=arguments[1],s=i.rows,r=[],e=0;for(;;){t=s.item(e);if(!t)break;r.push(t),e++}n.resolve(r)},t=function(){console.log("Select SQL statement error ",arguments[1]),n.reject()},e.executeSql("SELECT * FROM "+i+";",null,r,t)}),n},n.prototype.remove=function(t){var n,r,i,s,o;return n=this.config,s=n.schema,o=Object.keys(s)[0],i=s[o].key.keyPath,r=e(),t?(n._db.transaction(function(e){return e.executeSql("DELETE FROM "+o+" WHERE "+i+"=?;",[t],function(){return r.resolve(t)},function(){return console.log("Delete SQL statement error",arguments[1]),r.reject()})}),r):(r.reject(),r)},n.prototype.clear=function(){var t,n,r,i;return t=this.config,r=this.config.schema,i=Object.keys(r)[0],n=e(),t._db.transaction(function(e){return e.executeSql("DELETE FROM "+i,null,function(){return n.resolve()},function(){return console.log("Clear SQL statement error",arguments[1]),n.reject()})}),n},n.prototype.drop=function(){throw"Not support delete database, see the spec 4.1 Databases"},n}(n),r=function(){function t(e){var t;t={},t=c(l,e),this.config=t}return t.prototype.DO_OPEN="open",t.prototype.DO_CREATE="create",t.prototype.DO_READ="read",t.prototype.DO_READALL="readall",t.prototype.DO_REMOVE="remove",t.prototype.DO_CLEAR="clear",t.prototype.DO_DROP="drop",t.prototype.open=function(){var t,n;n=e();if(!this.DB){switch(this.config.type){case u:this.DB=new s(this.config),t=this.DB.open();break;case a:this.DB=new f(this.config),t=this.DB.open();break;default:throw"Type error"}return t.done(function(){n.resolve()}),t.fail(function(){n.reject()}),n}return n.resolve(),n},t.prototype["do"]=function(e){if(typeof e!="string")throw"Do command must be string.";if(!this.hasOwnProperty("DO_"+e.toUpperCase()))throw'No command named "'+e+'"';return e===this.DO_OPEN?this.open.apply(this,p(arguments,1)):this.DB[e].apply(this.DB,p.call(arguments,1))},t}(),h=function(e){return e==null&&(e=l),new r(e)},h.TYPE_INDEXEDDB=u,h.TYPE_WEBSQL=a,h});